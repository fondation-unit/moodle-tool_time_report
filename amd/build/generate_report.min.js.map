{"version":3,"sources":["../src/generate_report.js"],"names":["define","$","Ajax","Notification","Str","Url","GenerateReport","requestorId","userId","userName","contextId","parseInt","start","end","timer","file","formdata","polling","click","e","preventDefault","startDate","document","querySelector","valueAsNumber","endDate","console","log","completion","checkCompletion","icon","attr","imageUrl","alert","get_string","requestorid","userid","username","contextid","call","methodname","args","jsonformdata","JSON","stringify","done","str","addClass","html","prepend","that","setInterval","pollFile","bind","fail","exception","prototype","length","dlicon","data","status","content","path","removeClass","clearInterval","generateReport"],"mappings":"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","sourcesContent":["define(['jquery',\n    'core/ajax',\n    'core/notification',\n    'core/str',\n    'core/url'], function ($, Ajax, Notification, Str, Url) {\n        'use strict';\n\n        var GenerateReport = function (requestorId, userId, userName, contextId) {\n            this.requestorId = parseInt(requestorId);\n            this.userId = parseInt(userId);\n            this.userName = userName;\n            this.start = null;\n            this.end = null;\n            this.contextId = contextId;\n            this.timer = 2500;\n            this.file = false;\n            this.formdata = {};\n            this.polling = null;\n\n            $('#submitdate').click(function (e) {\n                e.preventDefault();\n\n                var startDate = document.querySelector('#startInput').valueAsNumber;\n                var endDate = document.querySelector('#endInput').valueAsNumber;\n                //var startDate = $('#startInput').val();\n                //var endDate = $('#endInput').val();\n                console.log(startDate, endDate);\n                var completion = this.checkCompletion(startDate, endDate);\n\n                var icon = $('<img/>');\n                icon.attr('alt', 'loading');\n                icon.attr('title', 'loading');\n                icon.attr('class', 'tool_time_report_icon loader');\n                icon.attr('src', Url.imageUrl('loading', 'tool_time_report'));\n\n                if (!completion) {\n                    return Notification.alert(\n                        Str.get_string('error'),\n                        Str.get_string('error:completiondates', 'tool_time_report')\n                    );\n                }\n\n                var formdata = {\n                    requestorid: this.requestorId,\n                    userid: this.userId,\n                    username: this.userName,\n                    start: startDate,\n                    end: endDate,\n                    contextid: this.contextId\n                };\n                this.formdata = formdata;\n\n                Ajax.call([{\n                    methodname: 'tool_time_report_generate_time_report',\n                    args: { jsonformdata: JSON.stringify(formdata) },\n                    done: function () {\n                        Str.get_string('client:reportgenerating', 'tool_time_report').done(function (str) {\n                            $('#report-area').addClass('alert-warning')\n                                .html(str).prepend(icon);\n                        });\n                        var that = this;\n                        (function foo() {\n                            that.polling = setInterval(pollFile.bind(that), 7500);\n                        })();\n                    }.bind(this),\n                    fail: Notification.exception\n                }]);\n            }.bind(this));\n        };\n\n        GenerateReport.prototype.checkCompletion = function (startDate, endDate) {\n            if (startDate.length == 0 || endDate.length == 0) {\n                return false;\n            }\n            return true;\n        };\n\n        var pollFile = function () {\n            var dlicon = $('<img/>');\n            dlicon.attr('alt', 'download');\n            dlicon.attr('title', 'download');\n            dlicon.attr('class', 'tool_time_report_icon');\n            dlicon.attr('src', Url.imageUrl('download', 'tool_time_report'));\n\n            Ajax.call([{\n                methodname: 'tool_time_report_poll_report_file',\n                args: { jsonformdata: JSON.stringify(this.formdata) },\n                done: function (data) {\n                    if (data.status == true) {\n                        Str.get_string('client:reportdownload', 'tool_time_report').done(function (str) {\n                            var content = $('<a href=\"' + data.path + '\" target=\"_blank\">' + str + '</a>').prepend(dlicon);\n                            $('#report-area').removeClass('alert-warning').addClass('alert-success')\n                                .html(content);\n                        });\n                        clearInterval(this.polling);\n                        return;\n                    }\n                }.bind(this),\n                fail: Notification.exception\n            }]);\n        };\n\n        return {\n            generateReport: function (requestorId, userId, userName, contextId) {\n                return new GenerateReport(requestorId, userId, userName, contextId);\n            }\n        };\n    });\n"],"file":"generate_report.min.js"}